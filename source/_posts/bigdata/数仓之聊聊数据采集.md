---
title: 数仓之聊聊数据采集
date: 2020-10-13 22:16:34
tags:
- 数据仓库
- 数据采集
---

# 数据采集之行为事件采集

## 1. 用户行为数据模型 -  Event Model

使用事件模型Event Model来描述用户在产品上的各种行为.

### 1.1  事件模型主要包括:

两个核心实体

- User(用户)
- Event(事件)

配合Item(物品)来做各种维度分析.

### 1.2 复杂的数据纬度, 统一的数据格式

 每个产品的数据指标都不同, 如PV, UV, 视频播放数, 做题数等.尤其一些细节、精细化的分析, 都需要复杂的数据纬度来支撑. 
<!--more-->
### 1.3 Event五要素

- Who:  登录用户ID, 匿名ID(cookie_id, 设备id)
- When: 事件发生实际时间, 要考虑到本地时间不一定准确的问题, 可以初始化时从服务器获取, 而服务器要做NTP服务
- Where: ip, GPS
- How: 从事这个事件的方式. 包括设备,浏览器,APP版本,OS版本,渠道,referer,屏幕宽高,是否wifi
- What: 用户所做事件的具体内容

eg: 

- 对于一个“购买”类型的事件，则可能需要记录的字段有：商品名称、商品类型、购买数量、购买金额、 付款方式等；
- 对于一个“搜索”类型的事件，则可能需要记录的字段有：搜索关键词、搜索类型等；
- 对于一个“点击”类型的事件，则可能需要记录的字段有：点击 URL、点击 title、点击位置等；
- 对于一个“用户注册”类型的事件，则可能需要记录的字段有：注册渠道、注册邀请码等；
- 对于一个“用户投诉”类型的事件，则可能需要记录的字段有：投诉内容、投诉对象、投诉渠道、投诉方式等；
- 对于一个“申请退货”类型的事件，则可能需要记录的字段有：退货金额、退货原因、退货方式等。

### 1.4 前端/客户端埋点 vs 后端

事件只在前端发生, 不往后端发送任何请求, 前端发

前端不能拿到事件所有(关键)字段,  后端发

事件数据后端也需要使用, 后端发

经常新增或修改指标, 后端发 (app涉及发版和用户更新问题)

对数据的完整性、一致性、即时性要求很高, 后端发(controller层在处理业务请求时同时发送)

eg: 

客户端通常会多条数据打包压缩, 等满足一定条件再发, 如果网络状况不好, 或者应用关闭or进入后台, 可能造成上传不及时

# 数据采集 - 数据同步方式

## 1. 接口级

推: 应用主动发送数据到大数据平台.

拉: 大数据平台定时从应用拉取数据.

优点:

 实现简单

缺点: 

耦合严重, 需要记录对方的访问信息和接口地址

可能要重复发送, 比如智课要把同样的数据发送两次

## 2. 消息队列

订阅: 应用将数据发布到消息队列, 大数据订阅主题并消费

优点: 

解耦, 应用不关心谁消费了这条消息

多个消费者可以同时消费

缺点:

复杂度, 可用性问题

## 3. 数仓收集

离线数据同步 sqoop, datax

增量数据同步 **canal, streamsets**

- canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送 dump 协议
- MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )
- canal 解析 binary log 对象(原始为 byte 流)

MySQL增量数据 - 字段映射并同步 - HBase/ES/RDB(mysql, postgresql, oracle, sqlserver...)

优点: 

不影响开发过程, 只需要定义好字段

缺点:

复杂度

无法在迁移过程中做复杂的转换